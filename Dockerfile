FROM ansibleplaybookbundle/apb-base

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IGltcG9ydC12bS1hcGIKZGVzY3JpcHRpb246IEltcG9ydCBWaXJ0\
dWFsIE1hY2hpbmUKYmluZGFibGU6IEZhbHNlCmFzeW5jOiBvcHRpb25hbAp0YWdzOgogIC0gdmly\
dHVhbG1hY2hpbmUKbWV0YWRhdGE6CiAgZGlzcGxheU5hbWU6IEltcG9ydCBWaXJ0dWFsIE1hY2hp\
bmUKICBpbWFnZVVybDogaHR0cHM6Ly9jZG4ucGJyZC5jby9pbWFnZXMvSDVHdXRkNy5wbmcKICBs\
b25nRGVzY3JpcHRpb246IHwKICAgICBJbXBvcnQgVmlydHVhbCBNYWNoaW5lIGZyb20gYW4gZXhp\
c3RpbmcgaW1hZ2Ugb3IgYSBWTXdhcmUgZW52aXJvbm1lbnQuCnBsYW5zOgogIC0gbmFtZTogdm13\
YXJlCiAgICBkZXNjcmlwdGlvbjogSW1wb3J0IGEgdmlydHVhbCBtYWNoaW5lIGZyb20gVk13YXJl\
IHZDZW50ZXIKICAgIGZyZWU6IFRydWUKICAgIG1ldGFkYXRhOgogICAgICBkaXNwbGF5TmFtZTog\
SW1wb3J0IGZyb20gVk13YXJlCiAgICBwYXJhbWV0ZXJzOgogICAgICAtIHRpdGxlOiBPcGVuU2hp\
ZnQgQWRtaW4gVXNlcm5hbWUKICAgICAgICBuYW1lOiBhZG1pbl91c2VyCiAgICAgICAgdHlwZTog\
c3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgLSB0aXRsZTogT3BlblNoaWZ0IEFk\
bWluIFBhc3N3b3JkCiAgICAgICAgbmFtZTogYWRtaW5fcGFzc3dvcmQKICAgICAgICB0eXBlOiBz\
dHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIGRpc3BsYXlfdHlwZTogcGFzc3dv\
cmQKICAgICAgLSB0aXRsZTogVk13YXJlIFVSTCB0byBFWFNpCiAgICAgICAgbmFtZTogdXJsCiAg\
ICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgLSB0aXRsZTog\
VmlydHVhbCBNYWNoaW5lIE5hbWUKICAgICAgICBuYW1lOiB2bV9uYW1lCiAgICAgICAgdHlwZTog\
c3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgLSB0aXRsZTogVk13YXJlIEFkbWlu\
IFVzZXJuYW1lCiAgICAgICAgbmFtZTogdXNlcm5hbWUKICAgICAgICB0eXBlOiBzdHJpbmcKICAg\
ICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIGRpc3BsYXlfdHlwZTogdXNlcm5hbWUKICAgICAg\
LSB0aXRsZTogVk13YXJlIEFkbWluIFBhc3N3b3JkCiAgICAgICAgbmFtZTogcGFzc3dvcmQKICAg\
ICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIGRpc3BsYXlf\
dHlwZTogcGFzc3dvcmQKICAgICAgLSB0aXRsZTogT3BlcmF0aW5nIFN5c3RlbSBUeXBlCiAgICAg\
ICAgbmFtZTogb3NfdHlwZQogICAgICAgIGRlZmF1bHQ6IGxpbnV4CiAgICAgICAgZW51bTogWyds\
aW51eCcsICd3aW5kb3dzJ10KICAgICAgICB0eXBlOiBlbnVtCiAgICAgIC0gdGl0bGU6IEltcG9y\
dCBWaXJ0dWFsIE1hY2hpbmUgYXMKICAgICAgICBuYW1lOiBpbWFnZV90eXBlCiAgICAgICAgZGVm\
YXVsdDogb3ZtCiAgICAgICAgZW51bTogWydvdm0nLCAndGVtcGxhdGUnXQogICAgICAgIHR5cGU6\
IGVudW0KICAtIG5hbWU6IHVybAogICAgZGVzY3JpcHRpb246IENyZWF0ZSBhIHZpcnR1YWwgbWFj\
aGluZSBmcm9tIGEgZG93bmxvYWRlZCBkaXNrIGltYWdlCiAgICBmcmVlOiBUcnVlCiAgICBtZXRh\
ZGF0YToKICAgICAgZGlzcGxheU5hbWU6IEltcG9ydCBmcm9tIFVSTAogICAgcGFyYW1ldGVyczoK\
ICAgICAgLSB0aXRsZTogT3BlblNoaWZ0IEFkbWluIFVzZXIKICAgICAgICBuYW1lOiBhZG1pbl91\
c2VyCiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgLSB0\
aXRsZTogT3BlblNoaWZ0IEFkbWluIFBhc3N3b3JkCiAgICAgICAgbmFtZTogYWRtaW5fcGFzc3dv\
cmQKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIGRp\
c3BsYXlfdHlwZTogcGFzc3dvcmQKICAgICAgLSB0aXRsZTogRGlzayBJbWFnZSBVUkwKICAgICAg\
ICBuYW1lOiBkaXNrX2ltYWdlX3VybAogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVp\
cmVkOiB0cnVlCiAgICAgIC0gdGl0bGU6IFZpcnR1YWwgTWFjaGluZSBUeXBlCiAgICAgICAgbmFt\
ZTogdm1fdHlwZQogICAgICAgIHR5cGU6IGVudW0KICAgICAgICBlbnVtOiBbJ2RlZmF1bHQnXQog\
ICAgICAgIHJlcXVpcmVkOiBUcnVlCiAgICAgICAgZGVmYXVsdDogZGVmYXVsdAogICAgICAgIGRp\
c3BsYXlfdHlwZTogc2VsZWN0CiAgICAgIC0gdGl0bGU6IFZpcnR1YWwgTWFjaGluZSBOYW1lCiAg\
ICAgICAgbmFtZTogdm1fbmFtZQogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVk\
OiB0cnVlCiAgICAgIC0gdGl0bGU6IE51bWJlciBvZiBDb3JlcwogICAgICAgIG5hbWU6IG5yX2Nw\
dXMKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIHR5cGU6IGludAogICAgICAgIGRlZmF1\
bHQ6IDEKICAgICAgLSB0aXRsZTogTWVtb3J5IChNaUIpCiAgICAgICAgbmFtZTogbWVtCiAgICAg\
ICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICB0eXBlOiBpbnQKICAgICAgICBkZWZhdWx0OiAxMDI0\
CiAgLSBuYW1lOiBsaWJ2aXJ0CiAgICBkZXNjcmlwdGlvbjogQ3JlYXRlIGEgdmlydHVhbCBtYWNo\
aW5lIGZyb20gbGlidmlydAogICAgZnJlZTogVHJ1ZQogICAgbWV0YWRhdGE6CiAgICAgIGRpc3Bs\
YXlOYW1lOiBJbXBvcnQgZnJvbSBsaWJ2aXJ0CiAgICBwYXJhbWV0ZXJzOgogICAgICAtIHRpdGxl\
OiBPcGVuU2hpZnQgQWRtaW4gVXNlcgogICAgICAgIG5hbWU6IGFkbWluX3VzZXIKICAgICAgICB0\
eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIHRpdGxlOiBPcGVuU2hp\
ZnQgQWRtaW4gUGFzc3dvcmQKICAgICAgICBuYW1lOiBhZG1pbl9wYXNzd29yZAogICAgICAgIHR5\
cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgZGlzcGxheV90eXBlOiBw\
YXNzd29yZAogICAgICAtIHRpdGxlOiBWaXJ0dWFsIE1hY2hpbmUgTmFtZQogICAgICAgIG5hbWU6\
IHZtX25hbWUKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQo="


COPY playbooks /opt/apb/actions
COPY roles /opt/ansible/roles
RUN chmod -R g=u /opt/{ansible,apb}
RUN yum -y install libvirt-client curl qemu-img wget libxslt libxml2 \
    && yum clean all
# We need this to get oc v3.9 due to the issue with oc apply. Once we would update apb-base to use 3.9 we can remove it

RUN curl -L -o /usr/bin/kubectl http://storage.googleapis.com/kubernetes-release/release/v1.9.0/bin/linux/amd64/kubectl
RUN curl -L https://github.com/fabiand/kubectl-plugin-pvc/raw/master/install.sh | bash

RUN wget https://github.com/openshift/origin/releases/download/v3.9.0/openshift-origin-client-tools-v3.9.0-191fece-linux-64bit.tar.gz
RUN tar zxvf openshift-origin-client-tools-v3.9.0-191fece-linux-64bit.tar.gz
RUN mv openshift-origin-client-tools-v3.9.0-191fece-linux-64bit/oc /usr/bin
RUN rm -rf openshift-origin-client-tools-v3.9.0-191fece-linux-64bit
RUN chmod u+x /usr/bin/oc

# future removal ends here
COPY bin/run-v2v.sh /v2v.d/
COPY bin/libvirt-to-kubevirt.sh /v2v.d/
RUN setfacl -Rm u:apb:rwx /v2v.d
USER apb
